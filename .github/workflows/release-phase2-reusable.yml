# =============================================================================
# Reusable Release Phase 2 Workflow
# =============================================================================
#
# Purpose:
#   Creates PR from development â†’ main after a release PR is merged to development.
#   This is Phase 2 of the 3-phase release automation.
#
# IMPORTANT: No Auto-Merge
#   This workflow does NOT enable auto-merge on the PR to main.
#   A human must manually merge the PR, which triggers Phase 3 via push event.
#   This is required because GITHUB_TOKEN merges don't trigger other workflows.
#
# Trigger:
#   Called by project repos (api, terminal, jobs) via workflow_call
#
# Flow:
#   1. Triggered when PR with 'automated-release' label is merged to development
#   2. Extracts version from release branch name (release/vX.Y.Z)
#   3. Creates PR from development â†’ main (NO auto-merge)
#   4. Deletes the release branch (already merged)
#   5. Human merges PR to main â†’ triggers Phase 3
#
# Usage in project repo:
#   on:
#     pull_request:
#       types: [closed]
#       branches: [development]
#   jobs:
#     release-phase2:
#       uses: faiyaz7283/dashtam/.github/workflows/release-phase2-reusable.yml@main
#       secrets: inherit
#
# =============================================================================

name: "Release Phase 2: Create PR to Main (Reusable)"

on:
  workflow_call:
    inputs:
      release_label:
        description: "Label that identifies automated release PRs"
        required: false
        default: "automated-release"
        type: string

jobs:
  create-main-pr:
    # Only run if:
    # 1. PR was actually merged (not just closed)
    # 2. PR has the release label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'automated-release')
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: development
      
      - name: Extract version from branch name
        id: version
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract version (e.g., release/v1.9.3 -> 1.9.3)
          if [[ "$BRANCH_NAME" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Extracted version: $VERSION"
          else
            echo "âŒ Invalid release branch format: $BRANCH_NAME"
            exit 1
          fi
      
      - name: Extract CHANGELOG entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract CHANGELOG section for this version
          CHANGELOG_ENTRY=$(awk '/^## \['"$VERSION"'\]/,/^## \[/{if(/^## \[/ && !/^## \['"$VERSION"'\]/) exit; print}' CHANGELOG.md)
          
          if [[ -z "$CHANGELOG_ENTRY" ]]; then
            echo "âš ï¸  No CHANGELOG entry found for v$VERSION"
            CHANGELOG_ENTRY="See CHANGELOG.md for details"
          fi
          
          # Save to file for multi-line output
          echo "$CHANGELOG_ENTRY" > /tmp/changelog.md
          echo "changelog_file=/tmp/changelog.md" >> $GITHUB_OUTPUT
      
      - name: Create PR from development to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ORIGINAL_PR="${{ github.event.pull_request.html_url }}"
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"
          
          # Build PR body
          PR_BODY=$(cat <<EOF
          ## Release v$VERSION
          
          Automated release PR created by Phase 2 GitHub Actions workflow.
          
          ### Changes
          $(cat "$CHANGELOG_FILE")
          
          ---
          
          **Previous PR**: $ORIGINAL_PR
          
          **Action Required**: Merge this PR to trigger Phase 3 (tag, release, sync).
          
          **Next Steps**:
          1. âœ… CI will run automatically
          2. ðŸ‘‰ **Merge this PR manually** when CI passes
          3. â³ Phase 3 will auto-trigger on merge (tag, release, sync)
          
          **Note**: This PR is labeled with \`automated-release\` for tracking.
          EOF
          )
          
          # Create PR (no auto-merge - human merge triggers Phase 3)
          PR_URL=$(gh pr create \
            --repo "${{ github.repository }}" \
            --base main \
            --head development \
            --title "chore(release): v$VERSION" \
            --body "$PR_BODY" \
            --label "automated-release")
          
          echo "âœ… Created PR from development â†’ main for v$VERSION"
          echo "PR URL: $PR_URL"
          echo "ðŸ“‹ Merge the PR manually to trigger Phase 3"
      
      - name: Delete release branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          # Delete remote release branch (commits already merged to development)
          git push origin --delete "$RELEASE_BRANCH" || echo "âš ï¸  Branch already deleted"
          
          echo "âœ… Deleted release branch: $RELEASE_BRANCH"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Failed to create PR to main"
          echo "Manual intervention required"
          exit 1
