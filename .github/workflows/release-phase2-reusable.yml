# =============================================================================
# Reusable Release Phase 2 Workflow
# =============================================================================
#
# Purpose:
#   Creates PR from development → main after a release PR is merged to development.
#   This is Phase 2 of the 3-phase release automation.
#
# Trigger:
#   Called by project repos (api, terminal, jobs) via workflow_call
#
# Flow:
#   1. Triggered when PR with 'automated-release' label is merged to development
#   2. Extracts version from release branch name (release/vX.Y.Z)
#   3. Creates PR from development → main
#   4. Enables auto-merge (merges when CI passes)
#   5. Deletes the release branch (already merged)
#
# Usage in project repo:
#   on:
#     pull_request:
#       types: [closed]
#       branches: [development]
#   jobs:
#     release-phase2:
#       uses: faiyaz7283/dashtam/.github/workflows/release-phase2-reusable.yml@main
#       secrets: inherit
#
# =============================================================================

name: "Release Phase 2: Create PR to Main (Reusable)"

on:
  workflow_call:
    inputs:
      release_label:
        description: "Label that identifies automated release PRs"
        required: false
        default: "automated-release"
        type: string

jobs:
  create-main-pr:
    # Only run if:
    # 1. PR was actually merged (not just closed)
    # 2. PR has the release label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, inputs.release_label || 'automated-release')
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: development
      
      - name: Extract version from branch name
        id: version
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract version (e.g., release/v1.9.3 -> 1.9.3)
          if [[ "$BRANCH_NAME" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "✅ Extracted version: $VERSION"
          else
            echo "❌ Invalid release branch format: $BRANCH_NAME"
            exit 1
          fi
      
      - name: Extract CHANGELOG entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract CHANGELOG section for this version
          CHANGELOG_ENTRY=$(awk '/^## \['"$VERSION"'\]/,/^## \[/{if(/^## \[/ && !/^## \['"$VERSION"'\]/) exit; print}' CHANGELOG.md)
          
          if [[ -z "$CHANGELOG_ENTRY" ]]; then
            echo "⚠️  No CHANGELOG entry found for v$VERSION"
            CHANGELOG_ENTRY="See CHANGELOG.md for details"
          fi
          
          # Save to file for multi-line output
          echo "$CHANGELOG_ENTRY" > /tmp/changelog.md
          echo "changelog_file=/tmp/changelog.md" >> $GITHUB_OUTPUT
      
      - name: Create PR from development to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ORIGINAL_PR="${{ github.event.pull_request.html_url }}"
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"
          
          # Build PR body
          PR_BODY=$(cat <<EOF
          ## Release v$VERSION
          
          Automated release PR created by Phase 2 GitHub Actions workflow.
          
          ### Changes
          $(cat "$CHANGELOG_FILE")
          
          ---
          
          **Previous PR**: $ORIGINAL_PR
          
          **Next Steps**:
          1. ✅ CI will run automatically
          2. ⏳ Review and merge this PR to \`main\`
          3. ⏳ Phase 3 will auto-tag release and sync branches
          
          **Note**: This PR is labeled with \`${{ inputs.release_label || 'automated-release' }}\` for automation.
          EOF
          )
          
          # Create PR
          PR_URL=$(gh pr create \
            --repo "${{ github.repository }}" \
            --base main \
            --head development \
            --title "chore(release): v$VERSION" \
            --body "$PR_BODY" \
            --label "${{ inputs.release_label || 'automated-release' }}")
          
          echo "✅ Created PR from development → main for v$VERSION"
          echo "PR URL: $PR_URL"
          
          # Enable auto-merge (will merge when CI passes)
          PR_NUMBER=$(basename "$PR_URL")
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --auto \
            --merge
          
          echo "✅ Enabled auto-merge for PR #$PR_NUMBER"
      
      - name: Delete release branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          # Delete remote release branch (commits already merged to development)
          git push origin --delete "$RELEASE_BRANCH" || echo "⚠️  Branch already deleted"
          
          echo "✅ Deleted release branch: $RELEASE_BRANCH"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Failed to create PR to main"
          echo "Manual intervention required"
          exit 1
